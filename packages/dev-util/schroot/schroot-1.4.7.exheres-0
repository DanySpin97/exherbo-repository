# Copyright 2010 Johannes Nixdorf <mixi@user-helfen-usern.de>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'schroot-1.4.3' from Gentoo, which is:
#     Copyright 1999-2010 Gentoo Foundation

# TODO: fix issues with automake
require debian-upstream [ suffix=".orig.tar.gz" ] autotools [ supported_automake=[ none ] supported_autoconf=[ 2.5 ] ]

SUMMARY="Utility to execute commands in a chroot environment"
HOMEPAGE="http://packages.debian.org/source/sid/schroot"

LICENCES="GPL-3"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="lvm btrfs doc pam"

DEPENDENCIES="
    build+run:
        dev-cpp/cppunit[>=1.10.0]
        dev-libs/boost[>=1.42.0]
        dev-libs/lockdev
        sys-apps/util-linux-ng[>=2.16]
        sys-devel/gettext
        btrfs? ( sys-fs/btrfs-progs )
        doc? (
            app-doc/doxygen
            media-gfx/graphviz
        )
        lvm? ( sys-fs/lvm2 )
        pam? ( sys-libs/pam )
"

# Tests require root
RESTRICT="test"

DEFAULT_SRC_PREPARE_PATCHES=(
    -p1 "${FILES}/${PNV}-fix-gcc-4.5.0.patch"
)

DEFAULT_SRC_CONFIGURE_OPTION_ENABLES=(
    'btrfs btrfs-snapshot'
    'doc doxygen'
    'lvm lvm-snapshot'
    pam
)

DEFAULT_SRC_CONFIGURE_PARAMS=(
    --disable-static
    --enable-block-device
    --enable-csbuild
    --enable-dchroot
    --enable-dchroot-dsa
    --enable-loopback
    --enable-shared
    --enable-union
    --enable-uuid
    --localstatedir=/var
    --with-bash-completion-dir=/usr/share/bash-completion
)

src_prepare() {
    default
    eautoconf
}

src_install() {
    default
    
    # config dir
    keepdir /etc/schroot/chroot.d
    # state dir
    keepdir /var/lib/schroot/mount
    keepdir /var/lib/schroot/session
    keepdir /var/lib/schroot/unpack
    keepdir /var/lib/schroot/union/overlay
    keepdir /var/lib/schroot/union/underlay
}
